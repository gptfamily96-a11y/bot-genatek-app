const express = require("express");
const fetch = (...args) =>
  import("node-fetch").then(({ default: fetch }) => fetch(...args));

const app = express();
app.use(express.json());

const API_URL = "https://waba-v2.360dialog.io/messages";
const API_KEY = process.env.DIALOG360_API_KEY;

async function send(payload) {
  await fetch(API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "D360-API-KEY": API_KEY
    },
    body: JSON.stringify(payload)
  });
}

async function sendText(to, body) {
  await send({
    messaging_product: "whatsapp",
    to,
    type: "text",
    text: { body }
  });
}

async function sendList(to, bodyText, rows) {
  await send({
    messaging_product: "whatsapp",
    to,
    type: "interactive",
    interactive: {
      type: "list",
      body: { text: bodyText },
      action: {
        button: "ุงุฎุชุฑ ูู ุงููุงุฆูุฉ",
        sections: [{ rows }]
      }
    }
  });
}

/* ====== ุงููุญุฏุฉ โ: ุงูุชุฑุญูุจ + ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ ====== */

const welcomeText =
`ุฃููุงู ุจู ูู ุฌููุงุชู ๐ฑ
ูุณุชุนุฏ ุชุชุนุฑูู ุนูู ุฌุณูู ูุฃูู ูุฑุฉุ โจ

ุฌููุงุชู ูุนุฑู ุญูุฑุชู ูุน ุฏูุงูุฉ ุงูุฃุนุฑุงุถุ
ููุฑูููุง ุงูุทุจู ุงููุชุฎุตุต ููุฌูุฏ
ุนุดุงู ูุดููู ุจุฃุชู ุตุญุฉ ูุนุงููุฉ ๐`;

const mainIntro =
`ูุง ุชุชุฑุฏุฏ ูู ุฃู ุณุคุงู ูุฎุทุฑ ุนูู ุจุงููุ
ูุชูุฏุฑ ุชุชุนุฑูู ุนูููุง ุฃูุซุฑ
ูู ุฎูุงู ุงูููุงุฆู ุงูุชุงููุฉ:`;

const mainMenu = [
  { id: "about", title: "ูู ูุญู โ ุฌููุงุชู" },
  { id: "what", title: "ูุง ูู ุงูุชุญููู ุงูุฌูููุ" },
  { id: "why", title: "ููุงุฐุง ุชุญุชุงุฌ ุงูุชุญูููุ" },
  { id: "steps", title: "ุฎุทูุงุช ุฑุญูุชู ูุนูุง" },
  { id: "after", title: "ูุงุฐุง ุจุนุฏ ุงููุชุงุฆุฌ" },
  { id: "packages", title: "ุชุนุฑูู ุนูู ุงูุจุงูุงุช" },
  { id: "start", title: "ุงุจุฏุฃ ุงูุขู / ุชุญุฏุซ ูุนูุง" },
  { id: "feedback", title: "ุงูุงูุชุฑุงุญุงุช / ุงูุดูุงูู" }
];

const infoSubMenu = [
  { id: "packages", title: "ุชุนุฑูู ุนูู ุงูุจุงูุงุช" },
  { id: "start", title: "ุงุจุฏุฃ ุงูุขู / ุชุญุฏุซ ูุนูุง" },
  { id: "main_menu", title: "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ" }
];

/* ====== ุงููุญุฏุฉ โก: ุงูุฃูุณุงู ุงูุชุนุฑูููุฉ ====== */

app.post("/webhook", async (req, res) => {
  res.sendStatus(200);

  const msg = req.body?.entry?.[0]?.changes?.[0]?.value?.messages?.[0];
  if (!msg) return;

  const from = msg.from;

  if (msg.type === "text") {
    await sendText(from, welcomeText);
    await sendList(from, mainIntro, mainMenu);
    return;
  }

  if (msg.type !== "interactive") return;
  const id = msg.interactive.list_reply.id;

  if (id === "main_menu") {
    await sendList(from, mainIntro, mainMenu);
    return;
  }

  if (id === "about") {
    await sendText(
      from,
`*ุฌููุงุชู ูู ุฃูุงุฆู ุงูุนูุงูุงุช ุงูุณุนูุฏูุฉ ุงููุชุฎุตุตุฉ ูู ูุฌุงู ุงูุทุจ ุงูุฌููู*

ุชุนูู ุชุญุช ุฅุดุฑุงู ูุงุฏุฑ ุทุจู ูุชููุฒ.

ููุฏูู ูุฌููุนุฉ ูู ุงูุชุญุงููู ุงูุฌูููุฉ (DNA)
ุชุณุงุนุฏู ุนูู ููู ุตุญุชู ูู ุงูุฌุฐูุฑ
ูุฅููุงุก ุฑุญูุฉ ุงูุชุดุฎูุต ุงูุทูููุฉ.`
    );

    await sendText(
      from,
`*ููุฃู ุฑุงุญุชู ุฃููููุฉุ ูุฌูู ููู ุงูุจูุช!*

ุชุจุฏุฃ ุฑุญูุชู ูุนูุง ูู ุงูููุฒูุ
ููุฏูุจูุง ูุฌูู ูุงุณุชูุงู ุงูุนููุฉุ
ููุฑุณู ูู ุงููุชุงุฆุฌ ููู ุนูุฏู.

ููุง ููุฏูู ุฌูุณุฉ ุงุณุชุดุงุฑูุฉ ุฎุงุตุฉ
ูุน ูุฑูููุง ุงูุทุจู ุงููุชุฎุตุต
ูุดุฑุญ ุงููุชุงุฆุฌ ูุจูุงุก ูุฑุงุฑุงุชู ุงูุตุญูุฉ.`
    );

    await sendList(
      from,
`*ุฌููุงุชู ูู ูุฌุฑุฏ ูุญุต*

ูู ุชุฌุฑุจุฉ ุตุญูุฉ ูุชูุงููุฉ
ุจุงุญุชุฑุงููุฉ ุนุงููุฉ ูุฎุตูุตูุฉ ุชุงูุฉ.`,
      infoSubMenu
    );
    return;
  }

  if (id === "what") {
    await sendText(
      from,
`*ูุง ูู ุงูุชุญููู ุงูุฌูููุ*

ุงูุชุญููู ุงูุฌููู ูู ูุญุต ูุฃุฌุฒุงุก ูุญุฏุฏุฉ
ูู ุญูุถู ุงููููู (DNA)
ุนู ุทุฑูู ุนููุฉ ุจุณูุทุฉ ูู ุงููุนุงุจ.`
    );

    await sendList(
      from,
`ูู ุฎูุงู ุชุญูููู ุงูุฌููู ููุฏุฑ ูููู:
โข ููู ุฃุนุฑุงุถ ูุนูููุฉ ุชุชูุฑุฑ ุนูุฏู
โข ููู ูุชูุงุนู ุฌุณูู ูุน ุงูุบุฐุงุก ูุงูุฃุฏููุฉ
โข ุงุณุชุนุฏุงุฏู ููุดุงูู ุตุญูุฉ ูุนูููุฉ`,
      infoSubMenu
    );
    return;
  }

  if (id === "why") {
    await sendText(
      from,
`*ููุด ุชุญุชุงุฌ ุงูุชุญููู ุงูุฌูููุ*

ุงูุชุญููู ุงูุฌููู ูุง ุตุงุฑ ุฑูุงููุฉุ
ูู ุฃูู ุฎุทูุฉ ุตุญูุฉ ูุงุฑูุฉ
ูููุตูู ูุฃูุถู ูุณุฎุฉ ุตุญูุฉ ูู ุฌุณูู.`
    );

    await sendList(
      from,
`ูุณุงุนุฏู ุนูู:
โข ููู ุงูุณุจุจ ุงูุญูููู ููุฃุนุฑุงุถ
โข ุจูุงุก ูุฑุงุฑุงุช ุตุญูุฉ ุนูู ุฌุณูู ุฃูุช
โข ุฅููุงุก ุฑุญูุฉ ุงูุญูุฑุฉ`,
      infoSubMenu
    );
    return;
  }

  if (id === "steps") {
    await sendText(
      from,
`*ุฑุญูุชู ูุน ุฌููุงุชู ูุงุถุญุฉ ูุงุญุชุฑุงููุฉ*

ุงุฎุชูุงุฑ ุงูุจุงูุฉ
ุงุณุชูุงู ุงูุนููุฉ
ุงูุชุญููู ุงูุฌููู
ุงูุชูุฑูุฑ
ุงูุฌูุณุฉ ุงูุงุณุชุดุงุฑูุฉ`
    );

    await sendList(from, "ุชุงุจุน:", infoSubMenu);
    return;
  }

  if (id === "after") {
    await sendText(
      from,
`*ูุงุฐุง ุจุนุฏ ุงููุชุงุฆุฌุ*

ุชุญุตู ุนูู ุชูุฑูุฑ ุฌููู ููุตูู
ูุชูุตูุงุช ุตุญูุฉ ูุฎุตูุตุฉ ูู
ูุฌูุณุฉ ุงุณุชุดุงุฑูุฉ ูููู ุงููุชุงุฆุฌ.`
    );

    await sendList(from, "ุงูุชุงูู:", infoSubMenu);
    return;
  }
});

app.listen(process.env.PORT || 3000);
